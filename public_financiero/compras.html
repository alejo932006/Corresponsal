<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras de Mercancía | Sistema Financiero</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/compras.css">
</head>
<body>

    <nav class="navbar">
        <div class="brand">
            <div class="logo-circle"><i class="fa-solid fa-truck"></i></div>
            COMPRAS Y PROVEEDORES
        </div>
        <div class="nav-links">
            <a href="menu.html" class="nav-item"><i class="fa-solid fa-table-cells-large"></i> IR AL MENÚ</a>
        </div>
        <div class="user-info">
            <span id="userDisplay">Usuario</span>
            <button onclick="logout()" class="btn-logout"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </nav>

    <div class="container">

        <div class="header-actions">
            <div>
                <h1>Gestión de Facturas</h1>
                <p>Registra tus compras y controla los vencimientos.</p>
            </div>
            <div style="display:flex; gap:10px;">
                
                <button class="btn-erp" onclick="consultarProveedoresERP()">
                    <i class="fa-solid fa-server"></i> CONSULTAR ERP
                </button>
                
                <button class="btn-alertas" onclick="verAlertas()">
                    <i class="fa-solid fa-bell"></i> VER VENCIMIENTOS
                    <span id="badgeAlertas" class="badge-count" style="display:none;">0</span>
                </button>
            </div>
        </div>

        <div class="card-form">
            <h3><i class="fa-solid fa-file-invoice-dollar"></i> Nueva Factura</h3>
            <form id="formCompras">
                <div class="form-grid">
                    
                    <div class="input-group wide">
                        <label>Nombre del Proveedor</label>
                        <input type="text" id="nombre_proveedor" placeholder="Ej: Distribuidora XYZ" required>
                    </div>
                    <div class="input-group">
                        <label>NIT (Solo Números)</label>
                        <input type="text" id="nit" placeholder="Ej: 900123456" required 
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>

                    <div class="input-group">
                        <label>Número de Factura</label>
                        <input type="text" id="numero_factura" placeholder="Ej: FE-4520" required>
                    </div>
                    <div class="input-group">
                        <label>Valor Total ($)</label>
                        <input type="number" id="valor" placeholder="0" min="0" step="0.01" required>
                    </div>

                    <div class="input-group">
                        <label>Fecha Ingreso</label>
                        <input type="date" id="fecha_ingreso" required onchange="calcularVencimiento()">
                    </div>
                    <div class="input-group">
                        <label>Plazo (Días)</label>
                        <input type="number" id="plazo_dias" placeholder="0" min="0" oninput="calcularVencimiento()">
                    </div>
                    <div class="input-group">
                        <label>Fecha Vencimiento</label>
                        <input type="date" id="fecha_vencimiento" readonly style="background-color: #f0f0f0; color: #d32f2f; font-weight: bold;">
                    </div>

                    <div class="input-group btn-container">
                        <button type="submit" class="btn-save">GUARDAR FACTURA</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="card-table">
            <table>
                <thead>
                    <tr>
                        <th>FECHA INGRESO</th>
                        <th>PROVEEDOR</th>
                        <th>NIT</th>
                        <th>FACTURA</th>
                        <th>PLAZO</th>
                        <th>VENCE</th>
                        <th class="text-right">VALOR</th>
                        <th class="text-center">ACCIÓN</th>
                    </tr>
                </thead>
                <tbody id="tablaCuerpo">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="modalAlertas" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header-alert">
                <h2><i class="fa-solid fa-triangle-exclamation"></i> Facturas por Vencer (3 Días)</h2>
                <button onclick="cerrarAlertas()" class="close-btn-white">&times;</button>
            </div>
            <div class="modal-body">
                <table class="table-alert">
                    <thead>
                        <tr>
                            <th>PROVEEDOR</th>
                            <th>FACTURA</th>
                            <th>VENCE EL</th>
                            <th>DÍAS RESTANTES</th>
                            <th class="text-right">VALOR</th>
                        </tr>
                    </thead>
                    <tbody id="tablaAlertasCuerpo"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button onclick="cerrarAlertas()" class="btn-cancel">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="modalERP" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-lg" style="max-width: 950px; height: 90vh; display: flex; flex-direction: column;">
            
            <div class="modal-header-alert" style="background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%);">
                <h2><i class="fa-solid fa-network-wired"></i> Cuentas por Pagar (Manager ERP)</h2>
                <button onclick="cerrarModalERP()" class="close-btn-white">&times;</button>
            </div>
    
            <div class="modal-body" style="padding: 0; flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
    
                <div class="erp-summary-panel">
                    <div class="summary-card card-total">
                        <small>TOTAL DEUDA PENDIENTE</small>
                        <h3 id="erpTotalDeuda">$ 0</h3>
                    </div>
                    <div class="summary-card card-count">
                        <small>CANTIDAD FACTURAS</small>
                        <h3 id="erpTotalFacturas">0</h3>
                    </div>
                </div>
            
                <div class="erp-filter-bar">
                    <div class="filter-group wide">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="erpFilterText" placeholder="Buscar por NIT, Factura o Nombre..." onkeyup="aplicarFiltrosERP()">
                    </div>
                    <div class="filter-group">
                        <i class="fa-solid fa-calendar"></i>
                        <input type="date" id="erpFilterDate" onchange="aplicarFiltrosERP()">
                    </div>
                    <button class="btn-clear-filter" onclick="limpiarFiltrosERP()" title="Borrar Filtros">
                        <i class="fa-solid fa-eraser"></i>
                    </button>
                </div>
            
                <div id="loadingERP" style="display:none; text-align:center; padding: 50px;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 3rem; color: #1565c0;"></i>
                    <p style="margin-top:15px; font-weight:bold; color: #555;">Consultando facturas pendientes...</p>
                </div>
            
                <div style="flex: 1; overflow-y: auto;">
                    <table class="table-alert" id="tablaERP" style="display:none;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th>FECHA</th>
                                <th>PROVEEDOR / NIT</th>
                                <th>FACTURA</th>
                                <th class="text-right">VALOR ERP</th>
                                <th class="text-right">VALOR LOCAL</th>
                                <th class="text-center">ESTADO</th>
                                <th class="text-center">ACCIÓN</th>
                            </tr>
                        </thead>
                        <tbody id="tablaERPCuerpo"></tbody>
                    </table>
                </div>
            </div>
    
            <div class="modal-footer">
                <button onclick="cerrarModalERP()" class="btn-cancel-modal">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="js/compras.js"></script>
</body>
</html>